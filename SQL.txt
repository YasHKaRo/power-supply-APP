-- Название БД power_supply_tests

CREATE DATABASE power_supply_tests;

CREATE TABLE norms (
    gost_id         INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    doc_number      VARCHAR(60)    NOT NULL,
    title           VARCHAR(60)    NOT NULL,
    description     TEXT,
    created_date    TIMESTAMP      NOT NULL
);

CREATE TABLE main_info (
    session_id      INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    test_date       DATE           NOT NULL,
    device_name     VARCHAR(50)    NOT NULL,
    serial_number   VARCHAR(50)    NOT NULL,
    overall_result  VARCHAR(20)    NOT NULL,
    comments        TEXT,
    gost_id         INTEGER,
    CONSTRAINT fk_main_info_norms
        FOREIGN KEY (gost_id)
        REFERENCES norms (gost_id)
        ON DELETE SET NULL
);

CREATE TABLE detail_test (
    result_id       INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    session_id      INTEGER        NOT NULL,
    test_name       VARCHAR(50)    NOT NULL,
    test_value      VARCHAR(50)    NOT NULL,
    passed          BOOLEAN        NOT NULL,
    duration        INTEGER        NOT NULL,
    CONSTRAINT fk_detail_test_main
        FOREIGN KEY (session_id)
        REFERENCES main_info (session_id)
        ON DELETE CASCADE
);

CREATE TABLE data_tests (
    data_id         INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    result_id       INTEGER        NOT NULL,
    test_value      INTEGER        NOT NULL,
    passed          BOOLEAN        NOT NULL,
    generated_date  TIMESTAMP      NOT NULL,
    CONSTRAINT fk_data_tests_detail
        FOREIGN KEY (result_id)
        REFERENCES detail_test (result_id)
        ON DELETE CASCADE
);

CREATE TABLE logs (
    log_id          INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    log_date        TIMESTAMP      NOT NULL,
    level           VARCHAR(40)    NOT NULL,
    message         TEXT           NOT NULL,
    session_id      INTEGER        NOT NULL,
    user_name       VARCHAR(40)    NOT NULL,
    CONSTRAINT fk_logs_main
        FOREIGN KEY (session_id)
        REFERENCES main_info (session_id)
        ON DELETE CASCADE
);

CREATE TABLE reports_path (
    report_id       INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    session_id      INTEGER        NOT NULL,
    txt_report_path  VARCHAR(255)   NOT NULL,
    docx_report_path VARCHAR(255)   NOT NULL,
    generated_date  TIMESTAMP      NOT NULL,
    CONSTRAINT fk_reports_path_main
        FOREIGN KEY (session_id)
        REFERENCES main_info (session_id)
        ON DELETE CASCADE
);
